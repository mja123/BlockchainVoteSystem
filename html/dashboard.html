<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VoteChain - Dashboard</title>
    <link rel="stylesheet" href="../css/styles.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans:ital,wght@0,100..900;1,100..900&display=swap"
      rel="stylesheet"
    />
  </head>

  <body>
    <div id="navbar-container"></div>

    <!-- Modal de bienvenida -->
    <div id="welcome-modal" class="modal">
      <div class="modal-content">
        <h2>Bienvenido a VoteChain</h2>
        <p style="text-align: center; max-width: 600px; margin: auto">
          Bienvenido a <strong>VoteChain</strong>, el sistema de votación
          digital basado en blockchain para garantizar transparencia, seguridad
          y confianza en las elecciones internas de nuestra ONG.
        </p>
        <p style="font-size: 0.9em; color: #666; margin-top: 20px">
          Todos los votos están asegurados mediante tecnología blockchain y son
          totalmente anónimos.
        </p>
        <button id="close-modal">Aceptar</button>
      </div>
    </div>

<div class="voting-container">
  <h1>VoteChain - Elecciones ONG</h1>
  <h3>Selecciona a tu candidato para la presidencia de la organización:</h3>
  <div class="options-container">
<button class="vote-option" data-option="candidato1">
  <div class="button-content"> <!-- Contenedor adicional -->
    <img src="../assets/adorni.png" alt="Manuel Adorni">
    <div class="candidate-info">
      <h4>Manuel Adorni</h4>
      <p>Propuesta: Transparencia y sostenibilidad</p>
    </div>
  </div>
</button>
<button class="vote-option" data-option="candidato1">
  <div class="button-content"> <!-- Contenedor adicional -->
    <img src="../assets/larreta.jpg" alt="Horacio Larreta">
    <div class="candidate-info">
      <h4>Horacio Larreta</h4>
      <p>Propuesta: Educacion Publica</p>
    </div>
  </div>
</button>
    
    <button class="vote-option" data-option="blanco">
      <div class="blank-vote-icon">✉️</div>
      <div class="candidate-info">
        <h4>Voto en blanco</h4>
        <p>No apoyar a ningún candidato</p>
      </div>
    </button>
  </div>

  <div class="results-container">
    <h2>Resultados de la votación:</h2>
    <div id="results"></div>
  </div>
</div>

    <script>
      // Configuración inicial
      let votes = {
        Adorni: 0,
        Larreta: 0,
        Blanco: 0
      };

      // Cargar votos previos
      if (localStorage.getItem("votes")) {
        votes = JSON.parse(localStorage.getItem("votes"));
      }

      // Función para actualizar resultados
      function updateResults() {
        const totalVotes = Object.values(votes).reduce((a, b) => a + b, 0);
        const resultsDiv = document.getElementById("results");
        resultsDiv.innerHTML = "";

        for (const [candidate, count] of Object.entries(votes)) {
          const percentage = totalVotes > 0 
            ? ((count / totalVotes) * 100).toFixed(1)
            : 0;

          resultsDiv.innerHTML += `
            <div class="result-item">
              <span class="candidate-name">${candidate}</span>
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${percentage}%"></div>
              </div>
              <span class="vote-count">${count} votos (${percentage}%)</span>
            </div>
          `;
        }
      }

      // Event listeners para los botones
      document.querySelectorAll(".vote-option").forEach((button) => {
        button.addEventListener("click", async (event) => {
          const selectedButton = event.currentTarget;
          const option = selectedButton.dataset.option;
          
          // Remover selección previa
          document.querySelectorAll(".vote-option").forEach(btn => {
            btn.classList.remove('selected');
          });
          selectedButton.classList.add('selected');

          if (confirm(`¿Confirmas tu voto para ${option}?`)) {
            const email = localStorage.getItem("email");
            try {
                const response = await fetch('http://localhost:3000/api/votes/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, candidate: option })
                });

                const data = await response.json();

                if (!response.ok) {
                    // Mostrar errores del servidor
                    if (data.errors) {
                        data.errors.forEach(error => {
                            const errorElement = document.getElementById(`${error.field}Error`);
                            if (errorElement) {
                                errorElement.textContent = error.message;
                                errorElement.style.display = 'block';
                            }
                        });
                    } else {
                        throw new Error(data.message || 'Error en el servidor');
                    }
                    return;
                }
            } catch (error) {
                console.error('Error:', error);
            }
            votes[option]++;
            localStorage.setItem("votes", JSON.stringify(votes));
            updateResults();
          }
        });
      });

      // Cargar navbar
      fetch("navbar.html")
        .then((response) => response.text())
        .then((data) => {
          document.getElementById("navbar-container").innerHTML = data;
        });

      // Mostrar modal al cargar
      window.addEventListener("DOMContentLoaded", () => {
        const modal = document.getElementById("welcome-modal");
        const closeBtn = document.getElementById("close-modal");

        modal.style.display = "flex";

        closeBtn.addEventListener("click", () => {
          modal.style.display = "none";
        });
        // Mostrar resultados iniciales
        updateResults();
      });
    </script>
  </body>
</html>
